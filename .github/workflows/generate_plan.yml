name: Generate Plan

on:
  workflow_dispatch:
    inputs:
      seed:
        description: 'Seed for plan generation (leave empty for auto)'
        required: false
        default: ''
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        cd planner
        pip install -e .

    - name: Validate Data
      run: mealplanner validate-data data

    - name: Generate Plan
      run: |
        SEED="${{ inputs.seed }}"
        if [ -z "$SEED" ]; then
          SEED=${{ github.run_number }}
        fi
        echo "ðŸŽ² Generating plan with seed **$SEED**" >> "$GITHUB_STEP_SUMMARY"
        mealplanner generate-plan data site/public --seed "$SEED"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Build Site
      run: |
        cd site
        npm ci
        npm run build

    - name: Upload site build
      uses: actions/upload-artifact@v4
      with:
        name: site-build
        path: site/dist/
        retention-days: 30

    - name: Summary
      run: |
        echo "### âœ… Plan generated and site built" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "Artifact \`site-build\` is ready. To deploy, run the **Deploy to Pages** workflow with run ID: \`${{ github.run_id }}\`" >> "$GITHUB_STEP_SUMMARY"
